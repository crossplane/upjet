spec:
  steps:
  - apply:
      files:
        - new-ssop/provider-family-aws.providers.pkg.crossplane.io_v1.yaml
    name: new-ssop
    manualExecution:
      - "kubectl apply -f new-ssop/provider-family-aws.providers.pkg.crossplane.io_v1.yaml"
    type: Apply
    description: "Installing the new family config provider"

  - exec:
      command: sh
      args:
        - "-c"
        - "kubectl wait provider.pkg provider-family-aws --for condition=Healthy"
    name: wait-for-healthy
    manualExecution:
      - sh -c "kubectl wait provider.pkg provider-family-aws --for condition=Healthy"
    type: Exec
    description: "Checking the health of new family config provider"

  - apply:
      files:
      - new-ssop/provider-aws-ec2.providers.pkg.crossplane.io_v1.yaml
      - new-ssop/provider-aws-eks.providers.pkg.crossplane.io_v1.yaml
    name: new-ssop
    manualExecution:
      - "kubectl apply -f new-ssop/provider-aws-ec2.providers.pkg.crossplane.io_v1.yaml"
      - "kubectl apply -f new-ssop/provider-aws-eks.providers.pkg.crossplane.io_v1.yaml"
    type: Apply
    description: "Installing the new family resource providers"

  - exec:
      command: sh
      args:
        - "-c"
        - "kubectl wait provider.pkg provider-aws-ec2 --for condition=Healthy"
    name: wait-for-healthy
    manualExecution:
      - sh -c "kubectl wait provider.pkg provider-aws-ec2 --for condition=Healthy"
    type: Exec
    description: "Checking health of new family resource provider"

  - exec:
      command: sh
      args:
        - "-c"
        - "kubectl wait provider.pkg provider-aws-eks --for condition=Healthy"
    name: wait-for-healthy
    manualExecution:
      - sh -c "kubectl wait provider.pkg provider-aws-eks --for condition=Healthy"
    type: Exec
    description: "Checking health of new family resource provider"

  - delete:
      options:
        finalizerPolicy: Remove
      resources:
        - group: pkg.crossplane.io
          kind: Provider
          name: provider-aws
          version: v1
    name: delete-monolithic-provider
    manualExecution:
      - "kubectl delete Provider.pkg.crossplane.io provider-aws"
    type: Delete
    description: "Deleting the monolithic provider package"

  - patch:
      type: merge
      files:
        - activate-ssop/provider-family-aws.providers.pkg.crossplane.io_v1.yaml
    name: activate-ssop
    manualExecution:
      - "kubectl patch --type='merge' -f activate-ssop/provider-family-aws.providers.pkg.crossplane.io_v1.yaml --patch-file activate-ssop/provider-family-aws.providers.pkg.crossplane.io_v1.yaml"
    type: Patch
    description: "Activating the new family config provider after the deletion of the monolithic one"

  - exec:
      command: sh
      args:
        - "-c"
        - "kubectl wait provider.pkg provider-family-aws --for condition=Installed"
    name: wait-for-installed
    manualExecution:
      - sh -c "kubectl wait provider.pkg provider-family-aws --for condition=Installed"
    type: Exec
    description: "Checking the installation of new family config provider"

  - patch:
      type: merge
      files:
        - activate-ssop/provider-aws-ec2.providers.pkg.crossplane.io_v1.yaml
        - activate-ssop/provider-aws-eks.providers.pkg.crossplane.io_v1.yaml
    name: activate-ssop
    manualExecution:
      - "kubectl patch --type='merge' -f activate-ssop/provider-aws-ec2.providers.pkg.crossplane.io_v1.yaml --patch-file activate-ssop/provider-aws-ec2.providers.pkg.crossplane.io_v1.yaml"
      - "kubectl patch --type='merge' -f activate-ssop/provider-aws-eks.providers.pkg.crossplane.io_v1.yaml --patch-file activate-ssop/provider-aws-eks.providers.pkg.crossplane.io_v1.yaml"
    type: Patch
    description: "Activating the new family resource providers"

  - exec:
      command: sh
      args:
        - "-c"
        - "kubectl wait provider.pkg provider-aws-ec2 --for condition=Installed"
    name: wait-for-installed
    manualExecution:
      - sh -c "kubectl wait provider.pkg provider-aws-ec2 --for condition=Installed"
    type: Exec
    description: "Checking installation of new service scoped provider"

  - exec:
      command: sh
      args:
        - "-c"
        - "kubectl wait provider.pkg provider-aws-eks --for condition=Installed"
    name: wait-for-installed
    manualExecution:
      - sh -c "kubectl wait provider.pkg provider-aws-eks --for condition=Installed"
    type: Exec
    description: "Checking installation of new service scoped provider"

version: 0.1.0
